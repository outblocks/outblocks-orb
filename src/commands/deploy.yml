description: "Deploy using Outblocks CLI."

parameters:
  env:
    type: string
    default: $OUTBLOCKS_ENV
    description: |
      Outblocks environment to use. Defaults to 'dev'.
  merge_mode:
    type: boolean
    default: false
    description: |
      Merge mode targets all apps that can be found (this is the same behavior as if all apps with visible app config were targeted manually).
  target_apps:
    type: string
    default: ""
    description: |
      Target only specified apps, specify in a form of <app type>.<name>, e.g.: static.website,service.api
  skip_apps:
    type: string
    default: ""
    description: |
      Skip specified apps (if they exist), specify in a form of <app type>.<name>, e.g.: static.website,service.api
  skip_all_apps:
    type: boolean
    default: false
    description: |
      Skip all apps (if they exist).
  skip_dns:
    type: boolean
    default: false
    description: |
      Skip DNS setup (including self managed certificates).
  skip_build:
    type: boolean
    default: false
    description: |
      Skip build command before deploy.
  skip_pull:
    type: boolean
    default: false
    description: |
      Skip docker images pull phase before deploy.
  set_vars:
    type: string
    default: ""
    description: |
      Set values, can specify multiple or separate values with commas: key1=val1,key2=val2.
  value_files:
    type: string
    default: ""
    description: |
      Specify values in a YAML file or a URL (can specify multiple) (default [<env>.values.yaml]).
  verify:
    type: boolean
    default: false
    description: |
      Verify existing resources before deploy.
  lock_wait:
    type: string
    default: 5m
    description: |
      How long should deployment try to acquire lock (if it is acquired by concurrent job). Defaults to '5m' (5 minutes).
  no_output_timeout:
    type: string
    default: "20m"
    description: |
      Time limit for no output to be produced before terminating the job. Defaults to '20m' (20 minutes).

steps:
  - run:
      name: Run Outblocks deployment
      no_output_timeout: <<parameters.no_output_timeout>>
      command: |
        args=()

        if [[ -n "<<parameters.env>>" ]]; then
          args+=(--env "<<parameters.env>>")
        fi

        if [[ -n "<<parameters.value_files>>" ]]; then
          args+=(--values "<<parameters.value_files>>")
        fi

        if [[ -n "<<parameters.target_apps>>" ]]; then
          args+=(--target-apps "<<parameters.target_apps>>")
        fi

        if [[ -n "<<parameters.skip_apps>>" ]]; then
          args+=(--skip-apps "<<parameters.skip_apps>>")
        fi

        if [[ -n "<<parameters.lock_wait>>" ]]; then
          args+=(--lock-wait "<<parameters.lock_wait>>")
        fi

        ok deploy --yes ${args[@]} \
          --set "<<parameters.set_vars>>" \
          <<#parameters.skip_all_apps>>--skip-all-apps<</parameters.skip_all_apps>> \
          <<#parameters.skip_dns>>--skip-dns<</parameters.skip_dns>> \
          <<#parameters.skip_build>>--skip-build<</parameters.skip_build>> \
          <<#parameters.skip_pull>>--skip-pull<</parameters.skip_pull>> \
          <<#parameters.verify>>--verify<</parameters.verify>>
